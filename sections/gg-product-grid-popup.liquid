{% comment %}
  GG Product Grid Popup (estilo Dawn)
  - Renderiza un heading + un botón/trigger
  - Abre un popup con un grid de productos elegidos en el customizer (Product 1..6)
  - Usa snippets nativos de Dawn: card-product + quick-add si corresponde
  - Incluye settings típicos de Dawn para cards
  - Incluye setting "color" (como pediste) para fondo del popup
{% endcomment %}

{{ 'template-collection.css' | asset_url | stylesheet_tag }}
{{ 'component-card.css' | asset_url | stylesheet_tag }}
{{ 'component-price.css' | asset_url | stylesheet_tag }}

{% if section.settings.image_shape == 'blob' %}
  {{ 'mask-blobs.css' | asset_url | stylesheet_tag }}
{%- endif -%}

{%- unless section.settings.quick_add == 'none' -%}
  {{ 'quick-add.css' | asset_url | stylesheet_tag }}
{%- endunless -%}

{%- if section.settings.quick_add == 'standard' -%}
  <script src="{{ 'quick-add.js' | asset_url }}" defer="defer"></script>
{%- elsif section.settings.quick_add == 'bulk' -%}
  <script src="{{ 'quick-add-bulk.js' | asset_url }}" defer="defer"></script>
  <script src="{{ 'quick-add.js' | asset_url }}" defer="defer"></script>
{%- endif -%}

{%- liquid
  assign products_to_render = 0
  for i in (1..6)
    assign key = 'product_' | append: i
    if section.settings[key] != blank
      assign products_to_render = products_to_render | plus: 1
    endif
  endfor
-%}

<section
  class="gg-product-grid-popup color-{{ section.settings.color_scheme }} gradient"
  id="gg-product-grid-popup-{{ section.id }}"
  data-section-id="{{ section.id }}"
>
  <div class="page-width">
    {%- if section.settings.heading != blank -%}
      <div class="title-wrapper-with-link">
        <h2 class="title inline-richtext">
          {{ section.settings.heading }}
        </h2>
      </div>
    {%- endif -%}

    {% comment %}
      Trigger para abrir el popup
      - Si querés que se abra por otro trigger (imagen/banner), se ajusta acá.
    {% endcomment %}
    <div class="gg-popup-trigger-wrap">
      <button
        type="button"
        class="button"
        data-gg-popup-open
        {% if products_to_render == 0 %}disabled{% endif %}
      >
        {{ section.settings.button_label }}
      </button>

      {%- if products_to_render == 0 -%}
        <p class="gg-popup-empty">
          No hay productos seleccionados en el bloque.
        </p>
      {%- endif -%}
    </div>
  </div>

  {% comment %}
    Estructura del POPUP
    - Overlay + Modal
    - Se muestra con clase is-open en el section
  {% endcomment %}
  <div class="gg-popup-overlay" data-gg-popup-overlay></div>

  <div
    class="gg-popup-modal"
    data-gg-popup-modal
    role="dialog"
    aria-modal="true"
    aria-label="{{ section.settings.heading | escape }}"
  >
    <button
      type="button"
      class="gg-popup-close"
      aria-label="Cerrar"
      data-gg-popup-close
    >
      ×
    </button>

    {% comment %}
      Header interno del popup
    {% endcomment %}
    <div class="gg-popup-modal__header">
      {%- if section.settings.heading != blank -%}
        <h3 class="gg-popup-modal__title">
          {{ section.settings.heading }}
        </h3>
      {%- endif -%}
    </div>

    {% comment %}
      Grid de productos (Dawn style)
      - Renderiza usando card-product
      - Respeta opciones: show_secondary_image, show_vendor, show_rating, etc.
      - Quick add: none/standard/bulk
    {% endcomment %}
    <div
      class="grid product-grid contains-card contains-card--product contains-card--standard"
      role="list"
      style="--gg-popup-max-width: {{ section.settings.max_width }}px;"
    >
      {%- for i in (1..6) -%}
        {%- assign key = 'product_' | append: i -%}
        {%- assign product_handle = section.settings[key] -%}

        {%- if product_handle != blank -%}
          {%- assign product = all_products[product_handle] -%}

          {%- if product != blank -%}
            <div class="grid__item" role="listitem">
              {% render 'card-product',
                card_product: product,
                media_aspect_ratio: section.settings.image_ratio,
                image_shape: section.settings.image_shape,
                show_secondary_image: section.settings.show_secondary_image,
                show_vendor: section.settings.show_vendor,
                show_rating: section.settings.show_rating,
                lazy_load: true,
                quick_add: section.settings.quick_add,
                section_id: section.id
              %}
            </div>
          {%- endif -%}
        {%- endif -%}
      {%- endfor -%}
    </div>

    {% comment %}
      Contenedor necesario para Quick Add (modal interno de Dawn)
    {% endcomment %}
    {%- if section.settings.quick_add != 'none' -%}
      <modal-dialog id="QuickAdd-{{ section.id }}" class="quick-add-modal">
        <div
          role="dialog"
          aria-label="{{ 'products.product.choose_product_options' | t }}"
          aria-modal="true"
          class="quick-add-modal__content global-settings-popup"
          tabindex="-1"
        >
          <button
            id="ModalClose-{{ section.id }}"
            type="button"
            class="quick-add-modal__toggle"
            aria-label="{{ 'accessibility.close' | t }}"
          >
            {{- 'icon-close.svg' | inline_asset_content -}}
          </button>
          <div id="QuickAddInfo-{{ section.id }}" class="quick-add-modal__content-info"></div>
        </div>
      </modal-dialog>
    {%- endif -%}
  </div>
</section>

{% comment %}
  Estilos del popup (mínimos y seguros)
  - Se apoyan en estilos base de Dawn para cards/grid
{% endcomment %}
<style>
  /* Wrapper trigger */
  #gg-product-grid-popup-{{ section.id }} .gg-popup-trigger-wrap {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-top: 12px;
  }

  #gg-product-grid-popup-{{ section.id }} .gg-popup-empty {
    margin: 0;
    opacity: .7;
    font-size: 14px;
  }

  /* Overlay */
  #gg-product-grid-popup-{{ section.id }} .gg-popup-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.55);
    opacity: 0;
    visibility: hidden;
    transition: opacity .25s ease, visibility .25s ease;
    z-index: 60;
  }

  /* Modal */
  #gg-product-grid-popup-{{ section.id }} .gg-popup-modal {
    position: fixed;
    top: 50%;
    left: 50%;
    width: min(100% - 32px, var(--gg-popup-max-width, 1200px));
    max-height: min(85vh, 900px);
    overflow: auto;

    transform: translate(-50%, -50%) scale(.98);
    opacity: 0;
    visibility: hidden;
    transition: opacity .25s ease, transform .25s ease, visibility .25s ease;

    z-index: 70;

    /* setting "color" aplicado acá */
    background: {{ section.settings.color }};
    border-radius: 12px;
    padding: 22px;
  }

  /* Estado abierto */
  #gg-product-grid-popup-{{ section.id }}.is-open .gg-popup-overlay,
  #gg-product-grid-popup-{{ section.id }}.is-open .gg-popup-modal {
    opacity: 1;
    visibility: visible;
  }

  #gg-product-grid-popup-{{ section.id }}.is-open .gg-popup-modal {
    transform: translate(-50%, -50%) scale(1);
  }

  /* Close */
  #gg-product-grid-popup-{{ section.id }} .gg-popup-close {
    position: sticky;
    top: 0;
    margin-left: auto;
    display: inline-flex;
    align-items: center;
    justify-content: center;

    width: 40px;
    height: 40px;

    border: 0;
    background: transparent;
    font-size: 28px;
    line-height: 1;
    cursor: pointer;
  }

  /* Header */
  #gg-product-grid-popup-{{ section.id }} .gg-popup-modal__header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    margin-bottom: 12px;
  }

  #gg-product-grid-popup-{{ section.id }} .gg-popup-modal__title {
    margin: 0;
    font-size: 18px;
  }
</style>

{% comment %}
  JS: abre/cierra popup
  - Cierra con overlay click
  - Cierra con ESC
{% endcomment %}
<script>
  (() => {
    const section = document.getElementById('gg-product-grid-popup-{{ section.id }}');
    if (!section) return;

    const openBtn = section.querySelector('[data-gg-popup-open]');
    const closeBtn = section.querySelector('[data-gg-popup-close]');
    const overlay = section.querySelector('[data-gg-popup-overlay]');

    const open = () => section.classList.add('is-open');
    const close = () => section.classList.remove('is-open');

    openBtn?.addEventListener('click', () => {
      if (openBtn.hasAttribute('disabled')) return;
      open();
    });

    closeBtn?.addEventListener('click', close);
    overlay?.addEventListener('click', close);

    document.addEventListener('keydown', (e) => {
      if (!section.classList.contains('is-open')) return;
      if (e.key === 'Escape') close();
    });
  })();
</script>

{% schema %}
{
  "name": "GG Product Grid Popup",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Tisso vison in the wild"
    },
    {
      "type": "text",
      "id": "button_label",
      "label": "Button label",
      "default": "Ver productos"
    },
    {
      "type": "range",
      "id": "max_width",
      "label": "Max width (px)",
      "min": 600,
      "max": 1400,
      "step": 50,
      "default": 1200
    },

    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "Color scheme",
      "default": "background-1"
    },

    {
      "type": "color",
      "id": "color",
      "label": "Color",
      "default": "#ffffff"
    },

    {
      "type": "select",
      "id": "image_ratio",
      "options": [
        { "value": "square", "label": "Square" },
        { "value": "portrait", "label": "Portrait" },
        { "value": "landscape", "label": "Landscape" }
      ],
      "default": "square",
      "label": "Image ratio"
    },
    {
      "type": "select",
      "id": "image_shape",
      "options": [
        { "value": "default", "label": "Default" },
        { "value": "blob", "label": "Blob" }
      ],
      "default": "default",
      "label": "Image shape"
    },

    {
      "type": "checkbox",
      "id": "show_secondary_image",
      "default": true,
      "label": "Show secondary image"
    },
    {
      "type": "checkbox",
      "id": "show_vendor",
      "default": false,
      "label": "Show vendor"
    },
    {
      "type": "checkbox",
      "id": "show_rating",
      "default": false,
      "label": "Show rating"
    },

    {
      "type": "select",
      "id": "quick_add",
      "label": "Quick add",
      "default": "none",
      "options": [
        { "value": "none", "label": "None" },
        { "value": "standard", "label": "Standard" },
        { "value": "bulk", "label": "Bulk" }
      ]
    },

    { "type": "product", "id": "product_1", "label": "Product 1" },
    { "type": "product", "id": "product_2", "label": "Product 2" },
    { "type": "product", "id": "product_3", "label": "Product 3" },
    { "type": "product", "id": "product_4", "label": "Product 4" },
    { "type": "product", "id": "product_5", "label": "Product 5" },
    { "type": "product", "id": "product_6", "label": "Product 6" }
  ],
  "presets": [
    { "name": "GG Product Grid Popup" }
  ]
}
{% endschema %}
